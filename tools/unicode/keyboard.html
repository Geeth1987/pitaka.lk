<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Standard Sinhala Keyboard - Wijesekara</title>
	<meta name="description" content="Official Keyboard used for typing Sinhala Unicode">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<link rel="icon" type="image/png" sizes="96x96" href="../../static/images/favicon-96x96.png">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<style id="font-face"></style> <!-- filled by script -->
	<link rel="stylesheet" href="main.css?v=1" />
	<style>
		#box1:focus { background-color: rgb(187, 241, 187); } 
		
		#keyboard { display: flex; flex-flow: column; }
		.key-row { display: flex; flex-flow: row nowrap; }

		.key { display: flex; flex-flow: row nowrap; 
			border: 0.5px solid #000; width: 4rem; height: 4rem; cursor: pointer; 
		}
		.unmodified { background-color: lightgray; }
		
		.key-col { display: flex; flex-flow: column nowrap; padding: 0.4rem; }
		.key-col._1 { flex-grow: 1; }
		.key-col._2 { color: darkblue; }

		.char { flex: 1 1 auto; }

		#others { display: flex; flex-flow: column wrap; }
		
		#specials-table td { vertical-align: top; padding: 0.3rem 1rem; }

		#box2 { color: darkgray; font-size: smaller; }
	</style>
</head>
	
<body>
	<div class="top-container" style="margin: 0 auto; max-width: 800px; align-content: center; text-align: justify;">
		<div id="top-contents" active="4"></div> <!--filled by script-->
		<div style="text-align: center; padding: 5px; background-color: lightyellow;">
			<span>Keyboard Layout ‡∂∫‡∂≠‡∑î‡∂ª‡∑î‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</span>
			<select class="apply-font" onchange="renderLayout(this.value)" id="layout-select" style="font-size: 1.5rem;">
				<option value="sing">‡∂ë‡∑É‡∑ê‡∂´ ‡∑É‡∑í‡∂Ç‡∂ú‡∑ä‡∂Ω‡∑í‡∑Ç‡∑ä</option>
				<option value="wije">‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑ö‡∂ö‡∂ª</option>
			</select>
		</div>

		<div class="section">
			<div class="textbox-title">‡∂î‡∂∂ ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∂ö‡∂Ω ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î</div>
			<textarea class="input apply-font" id="box1" rows="7"></textarea>
			<div class="input apply-font" id="box2" rows="7"></div>
		</div>

		<div class="section">
			<div id="keyboard"></div>
			<table id="specials-table" style="margin: 0.5rem;">
				<tr style="color: brown; font-size: 1.2rem;">
					<td>‡∂∫‡∂≠‡∑î‡∂ª‡∑î‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä‡∑ö ‡∂á‡∂≠‡∑í ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î</td><td>‡∂∫‡∂≠‡∑î‡∂ª‡∑î‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä‡∑ö ‡∂±‡∑ê‡∂≠‡∑í ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î</td>
				</tr>
				<tr>
					<td id="symbols"></td><td id="others"></td>
				</tr>
			</table>
		</div>

		<div class="section">
			
		</div>

		<div id="bottom-bar"></div>
	</div>

	<script src="./font-face.js"></script>	
	<script language="javascript" type="text/javascript">
		const keymap = [
			[
				['~,`','‡∂ª\u0dca\u200d,\u0dca\u200d‡∂ª', ''], // repaya, rakar
				['!,1', '', ''],
				['@,2', '', ''],
				['#,3', '', ''],
				['$,4', '', ''],
				['%,5', '', ''],
				['^,6', '', ''],
				['&,7', '', ''],
				['*,8', '', ''],
				['(,9', '', ''],
				['),0', '', ''],
				['_,-', '', ''],
				['+,=', '', ''],
				['Back space', '', '', 1.5],
			],
			[
				['Tab', '', '', 1.5],
				['Q,q', '\u0dd6,\u0dd4', '\u0dd1,\u0dd0'],
				['W,w', '‡∂ã,‡∂Ö', '‡∑Ü,‡∑Ä'],
				['E,e', '\u0dd1,\u0dd0', '\u0dda,\u0dd9'],
				['R,r', '‡∂ç,‡∂ª', '\u0dca\u200d‡∂ª,‡∂ª'], // rakar and ra
				['T,t', '‡∂î,‡∂ë', '‡∂®,‡∂ß'],
				['Y,y', '‡∑Å,‡∑Ñ', '\u0dca\u200d‡∂∫,‡∂∫'], // yansa
				['U,u', '‡∂π,‡∂∏', '\u0dd6,\u0dd4'],
				['I,i', '‡∑Ç,‡∑É', '\u0dd3,\u0dd2'],
				['O,o', '‡∂∞,‡∂Ø', '\u0ddd,\u0ddc'],
				['P,p', '‡∂°,‡∂†', '‡∂µ,‡∂¥'],
				['{,[', '‡∂•,‡∂§', ''],
				['},]', ':,;', ''],
				['|,\\', 'ü°Çü°Ä,‚áÜ', ''], // conjunct
			],
			[
				['Lock', '', '', 1.7],
				['A,a', '\u0ddf,\u0dca', '‡∑Å,\u0dcf'],
				['S,s', '\u0dd3,\u0dd2', '‡∑Ç,‡∑É'],
				['D,d', '\u0dd8,\u0dcf', '‡∂∞,‡∂Ø'],
				['F,f', '‡∑Ü,\u0dd9', 'ü°Çü°Ä,\u0dca'],
				['G,g', '‡∂®,‡∂ß', '‡∂ù,‡∂ú'],
				['H,h', '\u0dca\u200d‡∂∫,‡∂∫', 'x,‡∑Ñ'], // yansa
				['J,j', '‡∑Ö‡∑î,‡∑Ä', '‡∂£,‡∂¢'],
				['K,k', '‡∂´,‡∂±', '‡∂õ,‡∂ö'],
				['L,l', '‡∂õ,‡∂ö', '‡∑Ö,‡∂Ω'],
				[':,;', '‡∂Æ,‡∂≠', '‡∂Æ,‡∂≠'],
				['\",\'', '‚Ä°,.', ''],
				['Enter', '', '', 2],
			],
			[
				['Shift', '', '', 2],
				['Z,z', '\',\"', '‡∂§,‡∂•'], // ‡∂• is more common
				['X,x', '\u0d83,\u0d82', '\u0d83,\u0d82'], // same anusawara
				['C,c', '‡∂£,‡∂¢', '‡∂°,‡∂†'],
				['V,v', '‡∂™,‡∂©', '‡∂™,‡∂©'], // same
				['B,b', '‡∂ä,‡∂â', '‡∂∑,‡∂∂'],
				['N,n', '‡∂∑,‡∂∂', '‡∂´,‡∂±'],
				['M,m', '‡∂µ,‡∂¥', '‡∂π,‡∂∏'],
				['<,‚Ä°', '‡∑Ö,‡∂Ω', ''], // ‚Ä° used to indicate comma
				['>,.', '‡∂ù,‡∂ú', ',.'],
				['?,/', '', ''],
				['Shift', '', '', 2],
			],
			[
				['Ctrl', '', '', 2],
				['Alt', '', '', 2],
				['Space', '', '', 6],
				['Alt', '', '', 2], // '\u25dc' saknknaka
				['Ctrl', '', '', 2],
			],
		]

		const charSplit = col => col.split(',').map(c => c == '‚Ä°' ? ',' : c)
		const renderChar = c => `<div class="char">${c}</div>`
		const renderKeyCol = (col) => charSplit(col).map(renderChar).join('')
		let layout = 'sing' // default
		const renderKey = (key) => {
			const width = key.length > 3 ? key[3] : 1
			const unmodified = !key[1] ? 'unmodified' : ''
			const col0 = `<div class="key-col _1">${renderKeyCol(key[0])}</div>`
			const col1 = `<div class="key-col _2">${renderKeyCol(key[layout == 'sing' ? 2 : 1])}</div>`
			return `<div class="key ${unmodified}" style="width: ${width * 4}rem">${col0 + col1}</div>`
		}


		const symbols = [
			['‡∂ª\u0dca\u200d', '‡∂ª‡∑ö‡∂µ‡∂∫', 'wije'],
			['\u0dca\u200d‡∂ª', '‡∂ª‡∂ö‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫'],
			['\u0dca\u200d‡∂∫', '‡∂∫‡∂Ç‡∑É‡∂∫'],
			['ü°Çü°Ä', '‡∂≠‡∑ä‚Äç‡∑Ä ‡∂≠‡∑ä‚Äç‡∂Æ ‡∂Ü‡∂Ø‡∑ì ‡∑É‡∑Ñ ‡∂¥‡∑è‡∂Ω‡∑í ‡∂∂‡∑ê‡∂≥‡∑í ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î', 'sing'],
			['‚áÜ', '‡∂≠‡∑ä‚Äç‡∑Ä ‡∂≠‡∑ä‚Äç‡∂Æ ‡∂±‡∑ä‚Äç‡∂∞ ‡∂Ü‡∂Ø‡∑ì ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂∂‡∑ê‡∂≥‡∑ì‡∂∏', 'wije'],
			['ü°Çü°Ä', '‡∂¥‡∑è‡∂Ω‡∑í ‡∂∂‡∑ê‡∂≥‡∑ì ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î', 'wije'],
		]

		const altGr = [
			['‡∂ª\u0dca\u200d', '‡∂ª', 'sing'], // reph
			['‡∑õ', '\u0dd2', 'sing'], // I - space dependent
			['‡∑õ', '\u0dd9', 'sing'], // E - same as above
			['‡∑û', '\u0ddc', 'sing'], // O
			['‡∑ò', '\u0dd4', 'sing'], // U, iru

			['‡∂≥', '‡∂Ø'],
			['‡∂ü', '‡∂ú'],
			['‡∂¨', '‡∂©'],
			['‡∂¶', '‡∂¢'],
			['‡∂û', '‡∂Ç'],
			['‡∑¥', '.'], // rarely used below
			['‡∂è', '‡∂Ω', 'wije'],
			['‡∑ü', '\u0dcf', 'sing'], // gayanukitta - ‡∂è
			['‡∑≥', '\u0dca'], // diga gayanukitta - ‡∂ê
		]
		const renderOther = e => `<div>
			<span>${e[0]}</span>
			<span> = Alt + ${e[1]}</span>
		</div>`

		function renderLayout(value) {
			layout = value //document.getElementById('layout-select').value
			const renderKeyRow = (row) => `<div class="key-row">${row.map(renderKey).join('')}</div>`
			document.getElementById('keyboard').innerHTML = keymap.map(renderKeyRow).join('')

			document.getElementById('symbols').innerHTML = symbols
				.filter(ar => !ar[2] || ar[2] == layout)
				.map(e => `<div><span>${e[0]}</span> = <span>${e[1]}</span></div>`).join('')
			document.getElementById('others').innerHTML = altGr
				.filter(ar => !ar[2] || ar[2] == layout)
				.map(renderOther).join('')
		}
		renderLayout('sing')



		const charToDest = {'‚áÜ': '\u0dca\u200d', 'ü°Çü°Ä': '\u200d\u0dca'}
		function getConvertMap(layout) {
			const flat = [].concat.apply([], keymap), main = {}, alt = {}, ki = (layout == 'sing') ? 2 : 1
			flat.forEach(e => {
				if (!e[ki]) return;
				const source = charSplit(e[0]), dest = charSplit(e[ki])
				if (source.length != dest.length) console.error(`length mismatch ${e}`)
				source.forEach((s, i) => main[s] = charToDest[dest[i]] || dest[i])
			})
			altGr.filter(ar => !ar[2] || ar[2] == layout).forEach(e => alt[e[1]] = e[0])
			return { main, alt }
		}
		const layoutMappings = { 'sing': getConvertMap('sing'), 'wije': getConvertMap('wije') }

		let rightAltPressed = false
		const box1 = document.getElementById('box1')
		box1.focus()
		box1.onkeydown = e => {
			if (e.code == 'AltRight') { rightAltPressed = true; console.log('AltRight On') }

			const mapping = layoutMappings[layout]
			let dest = mapping.main[e.key] 
			if (!dest) return;
			console.log(e)
			if (rightAltPressed || e.altKey) { // (e.ctrlKey && - changed to just alt
				dest = mapping.alt[dest] || dest // altgr pressed
			} else if (e.ctrlKey) {
				return; // other modifiers should not be processed
			}
			let text = box1.value.substr(0, box1.selectionStart) + dest + box1.value.substr(box1.selectionEnd)
			const startLen = text.length

			if (layout == 'sing') text = customSing(text)
			// dependent vowels
			//text = text.replace(/\u200e\u0dd9([‡∂ö-‡∑Ü])/g, '$1\u0dd9') // combuva - move back cant made to work
			//text = text.replace(/\u0dd9((?:\u200d\u0dca|\u200d\u0dca)[‡∂ö-‡∑Ü])/g, '$1\u0dd9') // combuva
			text = text.replace(/\u0dd9\u0dca|\u0dca\u0dd9/g, '\u0dda') // ee - any order supported
			text = text.replace(/\u0dd9\u0dcf|\u0dcf\u0dd9/g, '\u0ddc') // o
			text = text.replace(/\u0dda\u0dcf|\u0dcf\u0dda|\u0ddc\u0dca|\u0dca\u0ddc/g, '\u0ddd') // oo
			text = text.replace(/\u0dd9\u0ddf|\u0ddf\u0dd9/g, '\u0dde') // ou
			text = text.replace(/\u0dd9\u0dd9/g, '\u0ddb') // ei
			text = text.replace(/\u0dd8\u0dd8/g, '\u0df2') // iruu
			// indept vowels
			text = text.replace(/‡∂Ö\u0dcf/g, '‡∂Ü')
			text = text.replace(/‡∂Ö\u0dd0/g, '‡∂á')
			text = text.replace(/‡∂Ö\u0dd1/g, '‡∂à')
			text = text.replace(/‡∂ã\u0ddf/g, '‡∂å')
			text = text.replace(/‡∂ç\u0dd8/g, '‡∂é')
			text = text.replace(/‡∂è\u0ddf/g, '‡∂ê')
			text = text.replace(/‡∂ë\u0dca/g, '‡∂í')
			text = text.replace(/‡∂ë\u0dd9/g, '‡∂ì')
			text = text.replace(/‡∂î\u0dca/g, '‡∂ï')
			text = text.replace(/‡∂î\u0ddf/g, '‡∂ñ')

			let caretPos = box1.selectionStart
			caretPos = caretPos + (text.length - startLen + dest.length);
			// advance caret further - in case it falls near al or zwj etc
			while (shouldAdvanceCaret(caretPos, text)) caretPos++
			box1.value = text // this resets the selectionStart
			box1.selectionStart = box1.selectionEnd = caretPos

			e.stopPropagation();
			e.preventDefault();
		}
		box1.onkeyup = e => {
			if (e.code == 'AltRight') {
				rightAltPressed = false; 
				console.log('AltRight Off'); 
			}

			// debug
			document.getElementById('box2').innerText =
				box1.value.split('').map((c, i) => {
					const r = (i == box1.selectionStart - 1) ? ' ‚Äñ' : ''
					return (c >= '‡∂Ö' && c <= '‡∑Ü' ? c : c.charCodeAt(0).toString(16)) + r
				}).join(' ')
		}

		function shouldAdvanceCaret(pos, text) {
			if (pos == 0 || pos == text.length || /[^\u0d80-\u0dff]/.test(text.charAt(pos))) return false;
			// if preceding or next char is al or zwj
			if (/\u0dca|\u200d/.test(text.charAt(pos - 1)) || /\u0dca|\u200d/.test(text.charAt(pos))) return true;
			// if next char is deptV
			return /[\u0dcf-\u0ddf]/.test(text.charAt(pos))
		}

		const deptToIndept = {
			'‡∑è': '‡∂Ö',
			'‡∑ê': '‡∂á',
			'‡∑ë': '‡∂à',
			'‡∑í': '‡∂â',
			'‡∑ì': '‡∂ä',
			'‡∑î': '‡∂ã',
			'‡∑ñ': '‡∂å',
			'‡∑ô': '‡∂ë',
			'‡∑ö': '‡∂í',
			'‡∑õ': '‡∂ì',
			'‡∑ú': '‡∂î',
			'‡∑ù': '‡∂ï',
			'‡∑û': '‡∂ñ',
			'‡∑ò': '‡∂ç',
			'‡∑≤': '‡∂é',
			'‡∑ü': '‡∂è',
			'‡∑≥': '‡∂ê',
		}
		const allDept = Object.keys(deptToIndept).join(''), 
			beginVowel = new RegExp(`^[${allDept}]`, 'g'), 
			nonSingVowel = new RegExp(`([^\u0d80-\u0dff])([${allDept}])`, 'g')
		function customSing(text) {
			text = text.replace(/([‡∂ö‡∂±‡∂≠])\u200d\u0dca([‡∑Ç‡∂Ø‡∂∞‡∑Ä‡∂Æ])/g, '$1\u0dca\u200d$2')
			text = text.replace(/(‡∂Ø)\u200d\u0dca([‡∂∞‡∑Ä])/g, '$1\u0dca\u200d$2')
			text = text.replace(beginVowel, (m) => deptToIndept[m])
			text = text.replace(nonSingVowel, (_m, g1, g2) => g1 + deptToIndept[g2])
			return text
		}

	</script>
</body>
</html>